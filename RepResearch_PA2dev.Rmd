---
title: 'Reproducible Research: Peer Assessment 2 (dev)'
author: "Richard Webber"
date: "Monday, August 18, 2014"
output:
  html_document:
    theme: cerulean
---

This document is a draft of the report and code that will need to be published (R Pubs) as my submission for Reproducible Research peer assessment 2. The objective for that project is to prepare a short report (certain features such as limits on document size, show all code, max of 3 plots (any type) are required) based on analysis of the NOAA Storm Database (not current: 1950-Nov.2011). The report is to answer two questions:  
1. Across US, which events are most harmful to human health?  
2. Across US, which events have the greatest economic consequences?  
  
Initially I will use this document as log for my analysis.  

## Section 1. Data Processing  

The data to be used for the project is the **NOAA Storm Database**. The following code downloads the version of the database provided for this project. The NOAA Storm Database categorizes storm related events with 37 variables; those of particular importance with regard to this analysis are variables that present: the event type, date, location, impact on human health (fatalities and injuries), and economic damage (structural and agricultural). So, given the large size of the data base, processing will immediately strip out unnecessary columns to improve the speed of manipulation. 


```{r download and prelimin processing, cache=TRUE}
library(R.utils)
library(data.table)
pa2 <- "http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
download.file(url=pa2, destfile="NOAAStorm.csv.bz2")
# NOAAStorm.csv is large (~540Mb), the following steps are slow
bunzip2("NOAAStorm.csv.bz2", overwrite=TRUE)
StormDB <- read.csv("NOAAStorm.csv", stringsAsFactors=FALSE, 
                na.strings=c("", "NA", "Not Available", "?"))
StormDT <- data.table(StormDB)
# remove columns that are unnecessary for this analysis
StormDT <- StormDT[, c(1,3:5, 9:22, 29:37):= NULL]
# convert key column data to lower case for ease of processing
StormDT <- StormDT[, EVTYPE:= tolower(EVTYPE)]
StormDT <- StormDT[, PROPDMGEXP:= tolower(PROPDMGEXP)]
StormDT <- StormDT[, CROPDMGEXP:= tolower(CROPDMGEXP)]
```
  
Details on the conventions and codes authorities use to report storm events to the database can be found at [Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf). The database documentation lists 48 event type categories (variable name EVTYPE in NOAA Storm Database) and provides extensive complex documentation for characterizing events. Given that storm events are often complex containing multiple components that are open to interpretation (one person's snow is another's sleet and so on), the event type variable (EVTYPE) in the NOAA Storm Database does not consist of a manageable number of levels. In fact, after removing upper/lower case variations, there are still `r length(unique(StormDT$EVTYPE))` unique event type entries in the database, some examples include:  
1. `r length(unique(StormDT$EVTYPE[grep("tornado", StormDT$EVTYPE)]))` unique entries for *tornado*,  
2. `r length(unique(StormDT$EVTYPE[grep("wind", StormDT$EVTYPE)]))` for *wind*, and  
3. `r length(unique(StormDT$EVTYPE[grep("flood", StormDT$EVTYPE)]))` for *flood*.  
Accordingly, *event types* will be processed into summary factor categories.  
On problem in summarizing EVTYPE in factors is event type entries (EVTYPE) often have multiple types per entry. For example, many thunderstorm entries also reference wind and hail and rain, in the same EVTYPE field, and so on. As thunderstorms often have damaging winds, I have made the choice to prioritize thunderstorms and by pulling thunderstorm first, then overwriting the entry in EVTYPE, I eliminate double counting into the factor summary. Entries that just reference wind are counted as such.  
```{r event factor processing}
library(data.table)
# the order of EVtypesearch was setup to deal with multiple entries
# as described in the text
EVtypesearch <- c("hurricane|tropical|typhoon", 
                  "coastal|storm surge|surf|tide|erosion", 
                  "avalanche|landslide|mud slide|mudslide|slide", 
                  "flood|dam", "tornado|funnel cloud|waterspout", "hail", 
                  "snow|blizzard|winter", 
                  "ice|freezing rain|frost|sleet|freezing|icy", 
                  "thunderstorm", "wind|microburst|gustnado|wnd", 
                  "rain|wet|precipitation|shower|precip", "lightning", 
                  "drought|dry", "heat|hot|high temperature|warm", "tsunami", 
                  "volcanic ash|volcanic", "seiche", "dust", 
                  "cold|cool|freeze", "fire|wildfire|smoke", "fog")
EVfactorlist <- c("hurricane", "coastal flooding", "landslide", "flooding", 
                "tornado", "hail", "snow storm", "ice storm", "thunderstorm", 
                "wind", "rain", "lightning", "drought", "extreme heat", 
                "tsunami", "volcanic ash", "seiche", "dust storm", 
                "extreme cold", "wildfire", "fog", "other")
EVdescription <- c("hurricane & tropical storms/depressions",
                   "coastal flooding & storm surges",
                   "avalanches, landslides, and mud/debris flows",
                   "inland flooding & flash flooding",
                   "tornados all classes & waterspouts",
                   "hail not captured as thunderstorms",
                   "snow storms & blizzards",
                   "ice storms, freezing rain, frosts, & sleet",
                   "thunderstorms", "wind not as thunderstorm or tornado",
                   "rain", "lightning", "drought", "extreme heat or heat waves",
                   "tsunami", "volcanic ash", "seiche", "dust storms",
                   "extreme cold", "wildfires includes forest & brush", 
                   "fog", "all unclassified & mislabeled types")
EVDT <- data.frame(EVfactorlist, EVdescription)
print("Table 1. Factor definitions for event types.")
EVDT
StormDT <- StormDT[, EVfactor:= "other"]
for(i in seq_along(EVtypesearch)){
        StormDT <- StormDT[grep(EVtypesearch[i], StormDT$EVTYPE), 
                           EVfactor:= EVfactorlist[i]]
        # overwrite EVTYPE to address multiple counting
        StormDT <- StormDT[grep(EVtypesearch[i], StormDT$EVTYPE), 
                           EVTYPE:= EVfactorlist[i]]
}
StormDT <- StormDT[, EVfactor:= factor(EVfactor)]
# remove old EVTYPE column
StormDT <- StormDT[, EVTYPE:= NULL]
```
  
According to the NOAA Storm Database documentation, property and crop damage estimates are reported with "K", "M", and "B" factors to indicate whether damage estimate values should be multiplied by 10^3^, 10^6^, and 10^9^ respectively. As with EVTYPE entries, entries into  property and crop multiplier factors columns are polluted with with nonappropriate entries. For this report it is not practical to investigate deviant entries, so all entries not conforming to the proper format will be ignored and a multiplier of 1 assumed.  
```{r damage estimate multipliers}
multiplierfactor <- c("k", "m", "b")
multiplier <- c(10^3, 10^6, 10^9)
for (i in seq_along(multiplierfactor)){
        StormDT <- StormDT[grep(multiplierfactor[i], StormDT$PROPDMGEXP), 
                           PROPDMG:= PROPDMG*multiplier[i]]
        StormDT <- StormDT[grep(multiplierfactor[i], StormDT$CROPDMGEXP), 
                           CROPDMG:= CROPDMG*multiplier[i]]
}
# removing columns that are now unnecessary
StormDT <- StormDT[, PROPDMGEXP:= NULL]
StormDT <- StormDT[, CROPDMGEXP:= NULL]
```
  
  